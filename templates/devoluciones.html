{{define "title"}}Devoluciones | Biblioteca PUCE{{end}}

{{define "content"}}
<div class="container my-5">
    <h2 class="mb-4 text-center"> Gesti贸n de Devoluciones</h2>
    <p class="lead text-center mb-3">Aqu铆 puedes ver los libros actualmente prestados y registrar su devoluci贸n.</p>

    <div id="devoluciones-message"></div>

    {{if .Mensaje}}
    <div class="alert alert-{{.TipoMensaje}} alert-dismissible fade show" role="alert">
        {{.Mensaje}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {{end}}

    {{if .DevolucionesData}}
    <div class="table-responsive">
        <table class="table table-hover table-bordered shadow-sm rounded-lg overflow-hidden">
            <thead class="bg-dark text-white">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Libro</th>
                    <th scope="col">Autor</th>
                    <th scope="col">Fecha de Pr茅stamo</th> <!-- 隆AGREGADO! -->
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {{range $index, $devolucion := .DevolucionesData}}
                <tr>
                    <td>{{inc $index}}</td>
                    <td>{{$devolucion.LibroNombre}}</td>
                    <td>{{$devolucion.AutorNombre}}</td>
                    <td>{{formatDate $devolucion.FechaPrestamo}}</td>
                    <td>
                        <button
                            class="btn btn-success btn-sm devolver-btn"
                            data-prestamoid="{{$devolucion.PrestamoID}}"
                            data-libroid="{{$devolucion.LibroID}}"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmDevolucionModal"
                            title="Registrar Devoluci贸n">
                            Devolver <i class="fas fa-undo-alt"></i>
                        </button>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="alert alert-info text-center" role="alert">
        No hay libros prestados actualmente para mostrar.
    </div>
    {{end}}
</div>

<!-- Modal de Confirmaci贸n de Devoluci贸n -->
<div class="modal fade" id="confirmDevolucionModal" tabindex="-1" aria-labelledby="confirmDevolucionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="confirmDevolucionModalLabel">Confirmar Devoluci贸n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                驴Est谩s seguro de que deseas registrar la devoluci贸n de este libro?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="confirmarDevolucionBtn">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM completamente cargado y parseado.'); // Debug: DOM cargado

    const confirmDevolucionModalElement = document.getElementById('confirmDevolucionModal');
    const confirmDevolucionModal = new bootstrap.Modal(confirmDevolucionModalElement);
    const confirmarDevolucionBtn = document.getElementById('confirmarDevolucionBtn');
    
    let prestamoActual = ""; // Variable para almacenar el ID del pr茅stamo actual
    let libroActual = "";    // Variable para almacenar el ID del libro actual

    // Escuchar el evento 'show.bs.modal' en el modal
    confirmDevolucionModalElement.addEventListener('show.bs.modal', function (event) {
        // 'relatedTarget' es el bot贸n que dispar贸 el modal (el bot贸n "Devolver")
        const button = event.relatedTarget; 
        prestamoActual = button.dataset.prestamoid; // Asignar a la variable de 谩mbito superior
        libroActual = button.dataset.libroid;       // Asignar a la variable de 谩mbito superior
        
        console.log('Modal de confirmaci贸n mostrando. PrestamoID del bot贸n disparador:', prestamoActual, 'LibroID del bot贸n disparador:', libroActual);
    });

    // Manejar el clic en el bot贸n "Confirmar" del modal
    confirmarDevolucionBtn.addEventListener('click', function () {
        console.log('Bot贸n "Confirmar" clicado.'); // Debug: Bot贸n confirmar clicado

        // Obtener los IDs de las variables de 谩mbito superior
        const prestamoIdToReturn = prestamoActual;
        const libroIdToUpdate = libroActual;

        if (!prestamoIdToReturn || !libroIdToUpdate) {
            console.error('IDs de pr茅stamo o libro no disponibles para la devoluci贸n.');
            alert('Error: No se pudo obtener la informaci贸n del pr茅stamo para la devoluci贸n. Intente recargar la p谩gina.'); // Mensaje al usuario
            return;
        }

        console.log('Enviando solicitud de devoluci贸n para PrestamoID:', prestamoIdToReturn, 'LibroID:', libroIdToUpdate); // Debug: Antes de fetch

        // Enviar la solicitud POST al servidor
        fetch('/devoluciones', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest' // Indicar que es una solicitud AJAX
            },
            body: `prestamoID=${encodeURIComponent(prestamoIdToReturn)}&libroID=${encodeURIComponent(libroIdToUpdate)}`
        })
        
    .then(response => {
  return response.text().then(text => {
    const msgContainer = document.getElementById('devoluciones-message');
    if (response.ok) {
      // 1锔 Cerrar el modal
      confirmDevolucionModal.hide();

      // 2锔 Asegurarnos de que se quiten clases y backdrops
      document.body.classList.remove('modal-open');
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

      // 3锔 Remover la fila de la tabla
      const btn = document.querySelector(`[data-prestamoid="${prestamoActual}"]`);
      if (btn) btn.closest('tr').remove();

      // 4锔 Mostrar mensaje de 茅xito integrado en la p谩gina
      msgContainer.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          Devoluci贸n registrada correctamente.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    } else {
      // Mismo proceso para el mensaje de error (sin cerrar el modal)
      msgContainer.innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          Error al procesar devoluci贸n: ${text}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }
  });
})
.catch(() => {
  const msgContainer = document.getElementById('devoluciones-message');
  msgContainer.innerHTML = `
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      Error de red al intentar la devoluci贸n.
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
});


    });
});
</script>
{{end}}
